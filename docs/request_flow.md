# Процесс обработки запросов на сертификаты в PKI системе

## Общий принцип работы

### Основной workflow
1. **Пользователь** создает и подписывает PKCS#10 запрос
2. **Пользователь** отправляет запрос **оператору**
3. **Оператор** проверяет запрос и оборачивает его в свой CMS (PKCS#7)
4. **Оператор** может добавить атрибут `szOID_ENROLLMENT_NAME_VALUE_PAIR` для переопределения параметров
5. **Оператор** отправляет запрос в **центр регистрации** с указанием `UserId` пользователя
6. **Центр регистрации** обрабатывает запрос и выпускает сертификат

### Ключевой принцип
**Система выпускает сертификат на основе:**
1. **Данных пользователя** из центра регистрации (Subject, атрибуты)
2. **Шаблона сертификата** (расширения, политики, параметры)
3. **Публичного ключа** из запроса PKCS#10

**Содержимое запроса пользователя используется минимально - в основном для аутентификации и получения ключа.**

### Важное замечание о доступе
**Пользователь взаимодействует с системой исключительно через оператора.** Оператор является единственным интерфейсом для работы с центром регистрации.

## Что берется из запроса пользователя

### Обязательно используется
- **PublicKey** - публичный ключ для сертификата (единственное критически важное поле)

### Может игнорироваться (переопределяться)
- **Subject DN** - Distinguished Name (берется из данных пользователя в центре регистрации)
- **Шаблон** - Certificate Template (может быть переопределен оператором)
- **Расширения** - Extensions (могут быть дополнены/переопределены в соответствии с шаблоном)
- **Другие атрибуты** - любые дополнительные поля

## Связь запроса с пользователем

Связь запроса с пользователем **исключительно через UserId** в `POST /api/ra/certRequests`:

```php
$certRequest = [
    'UserId' => $userGuid,           // Идентификатор пользователя
    'RawRequest' => $pkcs7Request,   // PKCS#7 с запросом
    'AuthorityName' => 'MyCA'        // Имя экземпляра ЦС (опционально)
];
```

## szOID_ENROLLMENT_NAME_VALUE_PAIR

### OID и формат
- **OID**: `1.3.6.1.4.1.311.13.2.1`
- **Формат**: Массив пар имя-значение (ключ всегда строка, значение всегда строка)
- **Расположение**: В подписи CMS сообщения

### Поддерживаемые поля для переопределения

| Поле | Ключ | Значение | Пример |
|------|------|----------|---------|
| Шаблон сертификата | `CertificateTemplate` | OID или имя шаблона | `"1.2.643.2.2.46.0.8"` |
| Срок действия сертификата | `CpRaCertPeriod` | Количество единиц | `"12"` |
| Единицы срока сертификата | `CpRaCertPeriodUnits` | Years/Months/Days | `"Months"` |
| Срок действия ключа ЭП | `CpRaKeyPeriod` | Количество единиц | `"24"` |
| Единицы срока ключа | `CpRaKeyPeriodUnits` | Years/Months/Days | `"Months"` |
| Дата начала действия | `CpRaStartDate` | yyyyMMddHHmmssK | `"20240101120000Z"` |
| Дата окончания действия | `CpRaExpirationDate` | yyyyMMddHHmmssK | `"20250101120000Z"` |
| Дата окончания ключа | `CpRaKeyExpirationDate` | yyyyMMddHHmmssK | `"20260101120000Z"` |

**Примечание:** Параметры позволяют оператору гибко управлять сроками действия сертификатов и ключей ЭП, переопределяя значения из PKCS#10 запроса пользователя.

### Пример комплексного использования

```php
// Оператор добавляет параметры в CMS для управления сроками
$nameValuePairs = [
    ["CertificateTemplate", "1.2.643.2.2.46.0.8"],
    ["CpRaCertPeriod", "12"],
    ["CpRaCertPeriodUnits", "Months"],
    ["CpRaKeyPeriod", "24"],
    ["CpRaKeyPeriodUnits", "Months"],
    ["CpRaStartDate", "20240101120000Z"],
    ["CpRaExpirationDate", "20250101120000Z"]
];
```

**Результат:** Сертификат будет выдан с указанным шаблоном и точными сроками действия, заданными оператором.

### Приоритет поиска шаблона
Система ищет шаблон в следующем порядке:
1. **szOID_ENROLLMENT_NAME_VALUE_PAIR** (CertificateTemplate) - переопределение оператором
2. **Атрибуты запроса** (wszPROPCERTTEMPLATE) - из PKCS#10
3. **Расширения запроса** (X509CertificateTemplateExtension) - из PKCS#10
4. **Шаблон по умолчанию** - из настроек центра регистрации

**Примечание:** Если шаблон не найден ни одним из способов, выпуск сертификата будет невозможен.

## Архитектура системы

### Компоненты
- **Пользователь** - создает PKCS#10 запрос
- **Оператор** - проверяет, подписывает и отправляет запросы в центр регистрации
- **Центр регистрации** - управление пользователями, обработка запросов и выпуск сертификатов
- **PKCS#10** - запрос на сертификат от пользователя
- **CMS (PKCS#7)** - контейнер с подписью оператора для передачи в центр регистрации

### Поток данных

```
Пользователь → PKCS#10 → Оператор → CMS с szOID_ENROLLMENT_NAME_VALUE_PAIR → Центр регистрации
       ↓              ↓              ↓                                        ↓
   PublicKey      UserId          Переопределения                     Сертификат
       ↓              ↓              ↓
       └──────────────┴──────────────┘
              (Контролируется оператором)
```

## Безопасность и контроль

### Контроль оператора
- **UserId** гарантирует связь с правильным пользователем
- **PublicKey** берется из подписанного запроса пользователя
- **Шаблон** определяет основные параметры сертификата
- **Оператор может переопределить** отдельные параметры через szOID_ENROLLMENT_NAME_VALUE_PAIR

### Контроль расширений
- **Шаблон** определяет базовый набор расширений
- **Политики безопасности** контролируют приоритет источников данных
- **Оператор** может переопределить расширения через szOID_ENROLLMENT_NAME_VALUE_PAIR

### Примеры политик безопасности
1. **Строгий контроль** - расширения всегда берутся из шаблона, запрос должен содержать все обязательные расширения
2. **Гибкая настройка** - пользователь может указывать свои расширения, шаблон предоставляет значения по умолчанию
3. **Минимальный контроль** - все расширения из шаблона добавляются автоматически
